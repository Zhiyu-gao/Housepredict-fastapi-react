#!/bin/bash

echo "=========================================="
echo " 🚀 HousePrice 全站部署开始"
echo "=========================================="

set -e  # 出错立即停止脚本

SERVER_IP="20.2.82.150"

#############################################
# 1. 更新代码
#############################################
echo "🔄 拉取 Git 最新代码..."
git pull 

echo ""
echo "=========================================="
echo " 🐳 构建 Docker 容器"
echo "=========================================="

# 2. 停掉旧容器
echo "🔄 停止旧服务..."
docker compose down

# 3. 重建镜像
echo "🔨 构建新镜像..."
docker compose up -d --build

echo ""
echo "=========================================="
echo " 🔍 检查容器状态"
echo "=========================================="

docker ps

echo ""
echo "=========================================="
echo " 🩺 后端健康检查"
echo "=========================================="

sleep 3
curl -s http://$SERVER_IP:8000/docs >/dev/null \
  && echo "✔ Backend 正常运行" \
  || echo "❌ Backend 健康检查失败"

echo ""
echo "=========================================="
echo " 🧠 AI Service 健康检查"
echo "=========================================="

curl -s http://$SERVER_IP:8080/docs >/dev/null \
  && echo "✔ AI Service 正常运行" \
  || echo "❌ AI Service 健康检查失败"

echo ""
echo "=========================================="
echo " 🎨 前端健康检查"
echo "=========================================="

curl -s http://$SERVER_IP >/dev/null \
  && echo "✔ Frontend 正常运行" \
  || echo "❌ Frontend 健康检查失败"

echo ""
echo "=========================================="
echo " 🚀 部署完成！项目已经成功运行！"
echo "=========================================="
